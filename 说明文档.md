# 说明文档

## 一.功能实现（玩家角度）

### （一）实现了骑士这个角色

1. 能通过w、a、s、d四个按键控制向八个方向移动。
2. 有血条，有护甲条，有能量条（尽管能量条只是个摆设）。受到敌人的攻击时会优先扣除护甲条，当护甲条消耗完时会扣除血条。在不受攻击的情况下损失的护甲条会逐渐恢复。
3. 有动画效果。分别有站立不动，移动，死亡三种动画，并随着玩家操作进行转换。

### （二）实现了角色-武器系统

1. 在游戏的一开始，角色的旁边会放置一把破旧的手枪，玩家可通过靠近武器并点击鼠标右键进行拾取，拾取之后武器将会跟随玩家并能进行射击与切换等操作。
2. 在游戏的地图中还有放置了宝箱的房间，当玩家靠近宝箱时，宝箱将会打开，并且产生一把武器，玩家可靠进武器进行拾取。
3. 角色手中的武器会随着鼠标的移动而旋转，枪口始终指向鼠标的方向。

### （三）实现了武器射击系统

1. 每把武器都配有特定的子弹，在玩家身上配备有武器的时候，玩家单击鼠标左键将会射出子弹，子弹射出的方向与枪口的朝向一致。玩家按住鼠标左键将会进行持续射击，子弹射出的频率受枪的冷却时间影响。
2. 当射出的子弹碰撞到敌人时，敌人将会受到伤害。

### （四）实现了房间-敌人系统

1. 房间的种类分为四种，出生房间、一般房间、宝箱房间以及boss房间。游戏开始时玩家处于出生房间，房间的门处于打开状态。当玩家前往下一个房间的种类是一般房间时，房门关闭，怪物苏醒，怪物将会对角色进行攻击。当玩家前往的下一个房间是宝箱房间时，房门并不会关闭，玩家可打开宝箱拾取里面的武器。当玩家进入boss房间时，房门关闭，boss死后，房门打开，并会在房间的中间形成一个传送门，玩家可靠近传送门并点击鼠标左键，游戏结束。

## 二.要求实现过程（程序角度）

### （一）实现骑士移动，携带破旧的手枪，鼠标控制瞄准方向，左键开火（单点和连射）等（实现了切换持有的武器）

1. 对骑士创建了PlayerControl脚本，写了MoveMent方法，函数中通过GexAxis方法将键盘上方向键的按下读入为数据，将此数据与角色速度等因素相乘，赋值给角色的坐标。在FixedUpdate中调用MoveMent方法就实现了对骑士移动的控制。
2. 在脚本中，通过圆形检测的方法向骑士周围发射射线检测周围是否有tag==“Weapon”的GameObject，有的话就将其赋值给WeaponInFloor变量，在此变量不为空且玩家点击鼠标左键时，将WeaponInFloor赋值给MyWeapon变量，调用transform.setparent方法，将骑士作为武器的父物体，实现武器跟随角色。
3. 在脚本中通过input.mouseposition获得鼠标的世界坐标，然后将鼠标的坐标与角色的坐标相减，得到方向向量，利用这个方向向量改变枪的朝向，就实现了用鼠标控制瞄准方向。
4. 在Weapon脚本中写了shoot（）方法，在PlayerControl脚本中当记录角色手上有枪的变量weapon不等于null且鼠标左键按下时，调用武器的shoot（）方法，该方法中用instantiate（）方法生成子弹，并通过调用Bullet脚本中的initialzation（）方法将伤害，武器名称以及对子弹施加的力的大小赋值给Bullet中的变量。以此来实现射出子弹。

### （二）实现森林大关的第一个小关（1-1），包括若干房间（实现了房门关闭）

1. 利用瓦片地图制作了森林关卡的地面以及围墙，将整个地图分为了七个房间。其中有四种类型的房间，针对美个房间类型写了相应的脚本，都继承于Room脚本。用IsExproed变量来记录房间的探索状态，为真时代表房间已经被探索过，为假时代表房间还没被探索，初始时IsExproed为假。每个房间增加了RoomTrigger脚本，用来判断角色是否进入该房间,如果角色进入且房间没被探索过，则调用相应类型房间脚本中的PlayerEnter（）方法，关闭房间门，唤醒怪物。当记录房间内怪物数量的变量为零时，打开房间门且IsExproed变为真。
2. 房间中的怪物则采用预先输入的方法（有想过写随机生成，但没那么多时间去做），将所有怪物放入一个空的父对象中，赋值给Room脚本中的RoomGroup变量，脚本中再用一个List表来分别存入每一个变量，同时调用Enemy脚本中的initialization方法给Enemy脚本中的room变量赋值，标记这些怪物属于当前房间。怪物死亡时，则List表中减去相应的怪物变量，当List表的长度为零时，则打开房门。
3. 其他特殊房间则针对于普通房间做相应的更改即可，都比普通房间的实现更为简单。

### （三）实现哥布林、野猪、哥布林祭祀、蓝藻花等怪物。实现基本的怪物AI

1. 在写怪物AI时首先要解决的就是寻路算法，于是我下载了A*Pathfinder Project资源包，将其导入项目，利用其提供的seeker.startpath方法来实现寻路算法。具体操作分为两种，一种是巡逻，另一种是索敌追击。
2. 巡逻时，采用在目标物体周围的圆内随机生成一个点将此作为目标点，然后调用写好的MoveAI（）方法，使怪物移动向目标物体。并且设置好了CD，让物体定时改变巡逻路径。说到这儿就不得不提CD的实现，本次项目的代码中所有的CD实现都采取了接下来阐述的方法。分别设置两个变量xxxCD、xxxtiming（初始为零），用Time.time减去xxxtiming，如果得到的值大于xxxCD则可以执行接下来的操作，否则不执行，每次进行判断后都令xxxtiming=Time.time。
3. 索敌追击的实现首先使用了视野检测的方法，利用Physics2D.Raycast()方法向物体周围发射射线（设置好射线的长度），当返回的碰撞物的transform等于角色的transform时，则进入索敌追击状态。在索敌追击状态时进行判断如果于角色的距离小于攻击范围时进入攻击状态，行动状态变为不动。如果角色出了攻击距离和索敌距离则相应的回到之前的状态。
4. 考虑到怪物受伤和角色受伤的一致性，我在GameControl脚本中写了BeAttack接口，分别在各自的脚本中进行了实现。BeAttack（float）方法设置了一个浮点参数，用来传入造成的伤害值，对怪物扣除相应的伤害值，角色则用设置好的护甲机制进行处理（即优先扣除护甲，护甲掉了才能扣除血量，当没有收到伤害后护甲会慢慢恢复）。
5. 对野猪怪，我设置了三种状态，分别是Idle，Stroll，Die。利用枚举类型来记录每一个状态并在Update中用switch不断刷新怪物所处的状态。初始状态为Idle状态，当角色进入，即isopen变量为真时，进入Stroll状态，当角色碰撞到野猪怪时将会调用自身的伤害函数，当子弹碰撞到野猪怪时将会调用野猪怪的伤害函数。野猪怪的血量将为零时，死亡，碰撞体禁用，并刷新房间的信息（List表减去相应怪物）。
6. 对蓝藻花（位置不会发生变化），我设置了三种状态，分别是Idle，Stroll，Die。除了Stroll其他状态都与野猪怪差别不大。在Stroll状态下，利用vector3.distance方法，当于角色的距离小于攻击距离时，蓝藻花就像四周发射二十个能量弹（简化为子弹），并设置好了CD。
7. 对哥布林，我设置了五种状态，分别时Idle，Stroll，Tracking，Attack，Die，Idle，1、2、5个状态都与野猪怪的实现方法大同小异，其余两个状态已经在3中说明，故不再赘述。哥布林祭祀的AI与哥布林小怪基本一样，但是由于时间紧张，没有付诸实施（动画做不出来，再加上boss战的实现还没有很明确的思路）。

### （四）实现场景中可破坏的木箱

木箱的实现也就是实现BeAttack接口，当有子弹碰撞时，调用木箱的BeAttack（）方法，扣除HP，当HP<=0时摧毁木箱。

### （五）实现了武器箱的功能

也就是通过判断与玩家的距离来开启宝箱，并在宝箱处生成一把武器预制体，玩家可以靠近该武器并点击鼠标左键进行拾取以切换当前手中的武器。

### （六）简陋的UI界面

简简单单地实现了开始画面，结束画面以及左上角的血条，护甲条，魔法条。boss死掉后单机restart可重玩（真的很简陋）

### （七）自认为代码构架还可以，可扩展性较高

刚开始写的代码没有主要的思路，想到哪儿写到哪儿，后来要实现功能的时候才发现这也要改，那也要改。于是专门找了一些资料，学习了一些代码整体框架的建立，学习了如何使代码更好的实现功能，如何拥有更高的扩展性。然后，把之前写的代码基本全部推翻了重敲（花费了大量时间）。现在的代码看着逻辑还是比较清楚的，也加了很多注释。

## 三.引用的插件和包

本次项目中用了A*patnfinding Project包实现寻路功能。

## 四.代码架构

1. 本次代码主要分为五大块，分别是Player，Weapon，Enemy，Room，Door。另有一单独的GameControl脚本用来设置BeAttack接口（本想着总体上来操控游戏中的一些画面显示，但没能实现多少UI）。

2. Player中PlayerControl脚本用来实现对角色的控制以及换枪、受伤等功能。
3. Weapon中设置父类Weapon，里面写了射击、初始化、捡枪、丢枪方法，子类有控制角色武器和怪物武器的脚本，分别实现对应功能。

3. Enemy中设置Enemy父类，写了初始化，死亡以及伤害函数，子类分别有野猪，蓝藻花，哥布林的控制脚本，还有一个AstarAI用来写寻路算法。
4. Room中设置Room父类，写了初始化，开门，关门，角色进入，更新房间信息，怪物死亡方法，子类有初始房间、一般房间、宝箱房间、boss房间的控制脚本，分别对其实现控制。

## 五.写在最后

这次的实习期很痛苦，真的花了很多很多的精力，但与痛苦对等的是收获，也真的收获了很多。学回了很多的知识，提升了代码能力暂且不说，全神贯注做完一件事是真的很爽啊。

### 关于迟交说明

真的是自己可能基础比较薄弱，总感觉时间太少，效率太低，不过我相信以后再做就熟练多了。（/(ㄒoㄒ)/~~）